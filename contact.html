<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Pay with Spaceremit</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 24px; background:#fafafa; }
    .wrap { max-width: 560px; margin: 0 auto; background: #fff; padding: 24px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
    h1 { margin: 0 0 8px; font-size: 22px; }
    p { color:#555; margin: 0 0 20px; }
    .sp-one-type-select { margin: 14px 0; padding: 12px; border: 1px solid #eee; border-radius: 10px; background:#fcfcfc; }
    label div { font-weight: 600; }
    button[type="submit"] { appearance: none; border: 0; background:#111; color:#fff; padding: 12px 18px; border-radius: 10px; cursor: pointer; font-weight: 600; }
    .hint { font-size: 12px; color:#777; margin-top: 8px; }
    .row { margin: 10px 0; }
    input[type="text"], input[type="email"] { width: 100%; padding: 10px 12px; border:1px solid #ddd; border-radius: 10px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Secure Payment</h1>
    <p>Complete your payment using local methods or card.</p>

    <!-- ===== Spaceremit Payment Form (IDs must match config) ===== -->
    <form id="spaceremit-form" style="margin-top:14px;">
      <!-- Optional buyer-visible fields (replace with your own) -->
      <div class="row">
        <input type="text"  id="buyer-name"  placeholder="Full name" value="John Doe" />
      </div>
      <div class="row">
        <input type="email" id="buyer-email" placeholder="Email" value="john@example.com" />
      </div>

      <!-- Hidden fields Spaceremit reads (set real values in production) -->
      <input type="hidden" name="amount"   value="1">
      <input type="hidden" name="currency" value="USD">
      <input type="hidden" name="fullname" id="hidden-fullname" value="John Doe">
      <input type="hidden" name="email"    id="hidden-email"    value="john@example.com">
      <input type="hidden" name="phone"    value="+15551234567">
      <input type="hidden" name="notes"    value="Order #1234">

      <!-- Local payment methods -->
      <div class="sp-one-type-select">
        <input type="radio" name="sp-pay-type-radio" value="local-methods-pay" id="sp_local_methods_radio" checked>
        <label for="sp_local_methods_radio"><div>Local payment methods</div></label>
        <div id="spaceremit-local-methods-pay" class="box"></div>
      </div>

      <!-- Card payment -->
      <div class="sp-one-type-select">
        <input type="radio" name="sp-pay-type-radio" value="card-pay" id="sp_card_radio">
        <label for="sp_card_radio"><div>Card payment</div></label>
        <div id="spaceremit-card-pay" class="box"></div>
      </div>

      <button type="submit">Pay</button>
      <div class="hint">Test first with a very small amount.</div>
    </form>
    <!-- ===== /Spaceremit Payment Form ===== -->
  </div>

  <!-- ===== Spaceremit CONFIG + SAFE LOADER ===== -->
  <script>
    // keep hidden fields in sync if the user edits the visible ones (optional)
    document.addEventListener("input", function (e) {
      if (e.target && e.target.id === "buyer-name")  document.getElementById("hidden-fullname").value = e.target.value;
      if (e.target && e.target.id === "buyer-email") document.getElementById("hidden-email").value    = e.target.value;
    });

    // Per Spaceremit docs: use CSS selectors (with #) for element targets
    const SP_PUBLIC_KEY = "pkGYSGWG6OTVCY20AA7YETVQI1BMUSR03YJ39UNW9Z10AN5CPDB4"; // your live key
    const SP_FORM_ID = "#spaceremit-form";
    const SP_SELECT_RADIO_NAME = "sp-pay-type-radio";

    const LOCAL_METHODS_BOX_STATUS = true;
    const LOCAL_METHODS_PARENT_ID = "#spaceremit-local-methods-pay";

    const CARD_BOX_STATUS = true;
    const CARD_BOX_PARENT_ID = "#spaceremit-card-pay";

    // OPTIONAL (common in their examples)
    let SP_FORM_AUTO_SUBMIT_WHEN_GET_CODE = true;

    // Required callbacks (names per Spaceremit)
    function SP_SUCCESSFUL_PAYMENT(spaceremit_code) {
      fetch("https://ywiyae4tgj.execute-api.us-east-1.amazonaws.com/verify-payment", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ payment_id: spaceremit_code })
      })
      .then(r => r.json())
      .then(result => {
        const paid = result?.status === "success" ||
                     result?.payment_status === "PAID" ||
                     result?.response_status === "success" ||
                     result?.data?.status === "Completed";
        alert(paid ? "✅ Payment verified!" : "❌ Payment not verified yet.");
        console.log("Verify result:", result);
      })
      .catch(err => console.error("Verify error:", err));
    }
    function SP_FAILD_PAYMENT(d){ console.warn("Payment failed:", d); }
    function SP_RECIVED_MESSAGE(m){ console.log("Spaceremit:", m); }
    function SP_NEED_AUTH(link){ console.warn("Spaceremit auth required:", link); }

    // ---- Safe loader: ensure elements exist, load spaceremit.js ONCE ----
    (function loadSpaceremit() {
      // remove any duplicate includes that could cause "already declared"
      document.querySelectorAll('script[src*="spaceremit.com/api/v2/js_script/spaceremit.js"]').forEach((n, i) => { if (i > 0) n.remove(); });

      function haveEls(){
        return document.querySelector(SP_FORM_ID) &&
               document.querySelector(LOCAL_METHODS_PARENT_ID) &&
               document.querySelector(CARD_BOX_PARENT_ID);
      }

      function inject() {
        if (window.__SPACEREMIT_LOADED__) return;
        window.__SPACEREMIT_LOADED__ = true;
        var s = document.createElement("script");
        s.src = "https://spaceremit.com/api/v2/js_script/spaceremit.js";
        s.async = false;
        document.body.appendChild(s);
      }

      function waitFor(max) {
        let tries = 0;
        (function tick(){
          if (haveEls()) inject();
          else if (tries++ < max) setTimeout(tick, 120);
          else console.error("Spaceremit targets not found. Check IDs/selectors:", { SP_FORM_ID, LOCAL_METHODS_PARENT_ID, CARD_BOX_PARENT_ID });
        })();
      }

      if (document.readyState === "complete" || document.readyState === "interactive") waitFor(60);
      else document.addEventListener("DOMContentLoaded", () => waitFor(60));
    })();
  </script>
  <!-- ===== /Spaceremit CONFIG + SAFE LOADER ===== -->
</body>
</html>
